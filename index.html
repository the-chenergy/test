<script src="https://hedalu244.github.io/diffle/data.js"></script>
<style>
    #c {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 32px 0;
        gap: 12px;
    }
    .w {
        display: flex;
    }
    .l {
        border: 2px solid;
        border-color: lightgray;
        margin: 4px;
        width: 36px;
        height: 36px;
        font-family: sans-serif;
        font-size: 18px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .b {
        background: darkgray;
        border-color: darkgray;
        color: white;
    }
    .y {
        background: goldenrod;
        border-color: goldenrod;
        color: white;
    }
    .g {
        background: mediumseagreen;
        border-color: mediumseagreen;
        color: white;
    }
    .gl {
        margin-left: 0;
        width: 40px;
    }
    .gr {
        margin-right: 0;
        width: 40px;
    }
    .gl.gr {
        width: 44px;
    }
    .gs {
        box-shadow: -12px 0 0 mediumseagreen;
        border-radius: 144px 0 0 144px;
    }
    .ge {
        box-shadow: 12px 0 0 mediumseagreen;
        border-radius: 0 144px 144px 0;
    }
    @media (prefers-color-scheme: dark) {
        body {
            filter: hue-rotate(180deg) invert(100%);
            background-color: #111;
        }
        .b,
        .y,
        .g {
            color: black;
        }
    }
</style>

<div id="c"></div>
<script>
    const things = [
        "Abandoned Mine",
        "Abundance",
        "Academy",
        "Acolyte",
        "Acting Troupe",
        "Advance",
        "Advisor",
        "Alchemist",
        "Alley",
        "Alliance",
        "Alms",
        "Altar",
        "Amass",
        "Amphora",
        "Amulet",
        "Animal Fair",
        "Annex",
        "Anvil",
        "Apothecary",
        "Apprentice",
        "Approaching Army",
        "Aqueduct",
        "Archer",
        "Architects' Guild",
        "Archive",
        "Arena",
        "Aristocrat",
        "Armory",
        "Artificer",
        "Artisan",
        "Artist",
        "Asceticism",
        "Astrolabe",
        "Avanto",
        "Avoid",
        "Bad Omens",
        "Baker",
        "Ball",
        "Band of Misfits",
        "Band of Nomads",
        "Bandit",
        "Bandit Camp",
        "Bandit Fort",
        "Banish",
        "Bank",
        "Banquet",
        "Barbarian",
        "Bard",
        "Bargain",
        "Barge",
        "Baron",
        "Barracks",
        "Basilica",
        "Bat",
        "Baths",
        "Battle Plan",
        "Battlefield",
        "Bauble",
        "Bazaar",
        "Beggar",
        "Berserker",
        "Biding Time",
        "Bishop",
        "Black Cat",
        "Black Market",
        "Blacksmith",
        "Blessed Village",
        "Blockade",
        "Bonfire",
        "Border Guard",
        "Border Village",
        "Borrow",
        "Bounty Hunter",
        "Bridge",
        "Bridge Troll",
        "Broker",
        "Bureaucracy",
        "Bureaucrat",
        "Buried Treasure",
        "Bury",
        "Bustling Village",
        "Butcher",
        "Cabin Boy",
        "Cage",
        "Camel Train",
        "Canal",
        "Candlestick Maker",
        "Capital",
        "Capital City",
        "Capitalism",
        "Captain",
        "Caravan",
        "Caravan Guard",
        "Cardinal",
        "Cargo Ship",
        "Carnival",
        "Carpenter",
        "Cartographer",
        "Catacombs",
        "Catapult",
        "Cathedral",
        "Cauldron",
        "Cavalry",
        "Cave Dwellers",
        "Cellar",
        "Cemetery",
        "Champion",
        "Change",
        "Changeling",
        "Chapel",
        "Chariot Race",
        "Charlatan",
        "Charm",
        "Cheap",
        "Church",
        "Circle of Witches",
        "Citadel",
        "City",
        "City Gate",
        "City Quarter",
        "City-state",
        "Clerk",
        "Coastal Haven",
        "Cobbler",
        "Coin of the Realm",
        "Collection",
        "Colonnade",
        "Colony",
        "Commerce",
        "Conclave",
        "Conjurer",
        "Conquest",
        "Conspirator",
        "Continue",
        "Contract",
        "Copper",
        "Coronet",
        "Corsair",
        "Council Room",
        "Count",
        "Counterfeit",
        "Courier",
        "Courser",
        "Courtier",
        "Courtyard",
        "Coven",
        "Crafters' Guild",
        "Craftsman",
        "Credit",
        "Crew",
        "Crop Rotation",
        "Crossroads",
        "Crown",
        "Crucible",
        "Crumbling Castle",
        "Crypt",
        "Crystal Ball",
        "Cultist",
        "Curse",
        "Cursed",
        "Cursed Gold",
        "Cursed Village",
        "Cutpurse",
        "Cutthroat",
        "Daimyo",
        "Dame Anna",
        "Dame Josephine",
        "Dame Molly",
        "Dame Natalie",
        "Dame Sylvia",
        "Death Cart",
        "Defiled Shrine",
        "Delay",
        "Deliver",
        "Deluded",
        "Delusion",
        "Delve",
        "Demand",
        "Demesne",
        "Den of Sin",
        "Desert Guides",
        "Desperation",
        "Destrier",
        "Develop",
        "Devil's Workshop",
        "Diplomat",
        "Disciple",
        "Dismantle",
        "Displace",
        "Distant Lands",
        "Distant Shore",
        "Divine Wind",
        "Dominate",
        "Donate",
        "Doubloons",
        "Druid",
        "Ducat",
        "Duchy",
        "Duke",
        "Dungeon",
        "Duplicate",
        "Elder",
        "Emissary",
        "Emporium",
        "Encampment",
        "Enchantress",
        "Enclave",
        "Endless Chalice",
        "Engineer",
        "Enhance",
        "Enlarge",
        "Enlightenment",
        "Envious",
        "Envoy",
        "Envy",
        "Estate",
        "Exorcist",
        "Expand",
        "Expedition",
        "Experiment",
        "Exploration",
        "Fair",
        "Fairgrounds",
        "Faithful Hound",
        "Falconer",
        "Familiar",
        "Family of Inventors",
        "Famine",
        "Farmers' Market",
        "Farmhands",
        "Farmland",
        "Farrier",
        "Fated",
        "Fawning",
        "Fear",
        "Fellowship of Scribes",
        "Feodum",
        "Ferry",
        "Ferryman",
        "Festival",
        "Figurehead",
        "Figurine",
        "First Mate",
        "Fisherman",
        "Fishing Village",
        "Fishmonger",
        "Flag",
        "Flag Bearer",
        "Flagship",
        "Fleet",
        "Flourishing Trade",
        "Fool",
        "Fool's Gold",
        "Footpad",
        "Forager",
        "Foray",
        "Foresight",
        "Forest Dwellers",
        "Forge",
        "Fortress",
        "Fortune",
        "Fortune Hunter",
        "Forum",
        "Fountain",
        "Friendly",
        "Frigate",
        "Fugitive",
        "Galleria",
        "Gamble",
        "Gang of Pickpockets",
        "Gardens",
        "Garrison",
        "Gatekeeper",
        "Gather",
        "Gear",
        "Ghost",
        "Ghost Town",
        "Giant",
        "Gladiator",
        "Goat",
        "Goatherd",
        "Gold",
        "Gold Mine",
        "Golem",
        "Gondola",
        "Good Harvest",
        "Governor",
        "Grand Castle",
        "Grand Market",
        "Graverobber",
        "Great Leader",
        "Greed",
        "Groom",
        "Grotto",
        "Groundskeeper",
        "Growth",
        "Guard Dog",
        "Guardian",
        "Guide",
        "Guildhall",
        "Guildmaster",
        "Haggler",
        "Hamlet",
        "Hammer",
        "Harbinger",
        "Harbor Village",
        "Harem  Farm",
        "Harsh Winter",
        "Hasty",
        "Haunted Castle",
        "Haunted Mirror",
        "Haunted Woods",
        "Haunting",
        "Haven",
        "Herald",
        "Herb Gatherer",
        "Herbalist",
        "Hermit",
        "Hero",
        "Hideout",
        "Highway",
        "Highwayman",
        "Hill Fort",
        "Hireling",
        "Hoard",
        "Horn",
        "Horn of Plenty",
        "Horse",
        "Hostelry",
        "Housecarl",
        "Hovel",
        "Huge Turnip",
        "Humble Castle",
        "Hunter",
        "Hunting Grounds",
        "Hunting Lodge",
        "Hunting Party",
        "Idol",
        "Imp",
        "Imperial Envoy",
        "Importer",
        "Improve",
        "Infirmary",
        "Inheritance",
        "Inherited",
        "Inn",
        "Innkeeper",
        "Innovation",
        "Insignia",
        "Inspiring",
        "Invasion",
        "Inventor",
        "Invest",
        "Investment",
        "Ironmonger",
        "Ironworks",
        "Island",
        "Island Folk",
        "Jack of All Trades",
        "Jester",
        "Jewelled Egg",
        "Jewels",
        "Journey",
        "Journeyman",
        "Joust",
        "Junk Dealer",
        "Keep",
        "Key",
        "Kiln",
        "Kind Emperor",
        "King's Cache",
        "King's Castle",
        "King's Court",
        "Kintsugi",
        "Kitsune",
        "Laboratory",
        "Labyrinth",
        "Lackeys",
        "Landing Party",
        "Lantern",
        "Launch",
        "League of Bankers",
        "League of Shopkeepers",
        "Legionary",
        "Leprechaun",
        "Library",
        "Lich",
        "Lighthouse",
        "Litter",
        "Livery",
        "Locusts",
        "Longship",
        "Lookout",
        "Looting",
        "Lost Arts",
        "Lost City",
        "Lost in the Woods",
        "Lucky Coin",
        "Lurker",
        "Madman",
        "Maelstrom",
        "Magic Lamp",
        "Magnate",
        "Magpie",
        "Mapmaker",
        "Marauder",
        "March",
        "Marchland",
        "Margrave",
        "Market",
        "Market Square",
        "Market Towns",
        "Maroon",
        "Marquis",
        "Masquerade",
        "Mastermind",
        "Menagerie",
        "Mercenary",
        "Merchant",
        "Merchant Camp",
        "Merchant Guild",
        "Merchant Ship",
        "Messenger",
        "Militia",
        "Mill",
        "Miller",
        "Mine",
        "Mining Road",
        "Mining Village",
        "Minion",
        "Mint",
        "Mirror",
        "Miser",
        "Miserable",
        "Misery",
        "Mission",
        "Moat",
        "Modify",
        "Monastery",
        "Moneylender",
        "Monkey",
        "Monument",
        "Mountain Folk",
        "Mountain Pass",
        "Mountain Shrine",
        "Mountain Village",
        "Museum",
        "Mystic",
        "Native Village",
        "Nearby",
        "Necromancer",
        "Necropolis",
        "Night Watchman",
        "Ninja",
        "Nobles",
        "Nomads",
        "Oasis",
        "Obelisk",
        "Old Map",
        "Old Witch",
        "Opulent Castle",
        "Orb",
        "Orchard",
        "Order of Astrologers",
        "Order of Masons",
        "Outpost",
        "Overgrown Estate",
        "Overlord",
        "Paddock",
        "Page",
        "Pageant",
        "Palace",
        "Panic",
        "Pasture",
        "Pathfinding",
        "Patient",
        "Patrician",
        "Patrol",
        "Patron",
        "Pawn",
        "Peaceful Cult",
        "Peasant",
        "Peddler",
        "Pendant",
        "Peril",
        "Philosopher's Stone",
        "Piazza",
        "Pickaxe",
        "Pilgrim",
        "Pilgrimage",
        "Pillage",
        "Pious",
        "Pirate",
        "Pixie",
        "Plague",
        "Plan",
        "Plateau Shepherds",
        "Platinum",
        "Plaza",
        "Plunder",
        "Poacher",
        "Poet",
        "Pooka",
        "Poor House",
        "Populate",
        "Port",
        "Possession",
        "Potion",
        "Pouch",
        "Poverty",
        "Practice",
        "Prepare",
        "Priest",
        "Prince",
        "Prize Goat",
        "Procession",
        "Progress",
        "Prosper",
        "Province",
        "Pursue",
        "Puzzle Box",
        "Quarry",
        "Quartermaster",
        "Quest",
        "Rabble",
        "Raid",
        "Raider",
        "Ranger",
        "Rapid Expansion",
        "Ratcatcher",
        "Rats",
        "Raze",
        "Reap",
        "Rebuild",
        "Receive Tribute",
        "Reckless",
        "Recruiter",
        "Relic",
        "Remake",
        "Remodel",
        "Renown",
        "Replace",
        "Research",
        "Rice",
        "Rice Broker",
        "Rich",
        "Ride",
        "Ritual",
        "River Shrine",
        "Riverboat",
        "Road Network",
        "Rocks",
        "Rogue",
        "Ronin",
        "Root Cellar",
        "Rope",
        "Royal Blacksmith",
        "Royal Carriage",
        "Royal Galley",
        "Ruined Library",
        "Ruined Market",
        "Ruined Village",
        "Rush",
        "Rustic Village",
        "Sack of Loot",
        "Sacred Grove",
        "Sacrifice",
        "Sage",
        "Sailor",
        "Salt the Earth",
        "Salvager",
        "Samurai",
        "Sanctuary",
        "Sauna",
        "Save",
        "Scavenger",
        "Scepter",
        "Scheme",
        "Scholar",
        "Scouting Party",
        "Scrap",
        "Scrounge",
        "Scrying Pool",
        "Sculptor",
        "Sea Chart",
        "Sea Trade",
        "Sea Witch",
        "Search",
        "Seaway",
        "Secluded Shrine",
        "Secret Cave",
        "Secret Passage",
        "Seer",
        "Seize the Day",
        "Sentinel",
        "Sentry",
        "Settlers",
        "Sewers",
        "Sextant",
        "Shaman",
        "Shanty Town",
        "Sheepdog",
        "Shepherd",
        "Shield",
        "Shop",
        "Shy",
        "Sibyl",
        "Sickness",
        "Silk Merchant",
        "Silos",
        "Silver",
        "Silver Mine",
        "Sinister Plot",
        "Sir Bailey",
        "Sir Destry",
        "Sir Martin",
        "Sir Michael",
        "Sir Vander",
        "Siren",
        "Skirmisher",
        "Skulk",
        "Sleigh",
        "Small Castle",
        "Smithy",
        "Smugglers",
        "Snake Witch",
        "Snowy Village",
        "Soldier",
        "Soothsayer",
        "Sorcerer",
        "Sorceress",
        "Souk",
        "Specialist",
        "Spell Scroll",
        "Spice Merchant",
        "Spices",
        "Spoils",
        "Sprawling Castle",
        "Squire",
        "Stables",
        "Staff",
        "Stampede",
        "Star Chart",
        "Stash",
        "Steward",
        "Stockpile",
        "Stonemason",
        "Storeroom",
        "Storyteller",
        "Stowaway",
        "Stronghold",
        "Student",
        "Summon",
        "Sunken Treasure",
        "Supplies",
        "Survivors",
        "Swamp Hag",
        "Swamp Shacks",
        "Swap",
        "Swashbuckler",
        "Swindler",
        "Sword",
        "Sycophant",
        "Tactician",
        "Tanuki",
        "Taskmaster",
        "Tax",
        "Tea House",
        "Teacher",
        "Temple",
        "Tent",
        "Territory",
        "The Earth's Gift",
        "The Field's Gift",
        "The Flame's Gift",
        "The Forest's Gift",
        "The Moon's Gift",
        "The Mountain's Gift",
        "The River's Gift",
        "The Sea's Gift",
        "The Sky's Gift",
        "The Sun's Gift",
        "The Swamp's Gift",
        "The Wind's Gift",
        "Throne Room",
        "Tiara",
        "Tide Pools",
        "Tireless",
        "Toil",
        "Tomb",
        "Tools",
        "Tormentor",
        "Torturer",
        "Tower",
        "Town",
        "Town Crier",
        "Tracker",
        "Trade",
        "Trader",
        "Trading Post",
        "Tragic Hero",
        "Trail",
        "Training",
        "Transmogrify",
        "Transmute",
        "Transport",
        "Trappers' Lodge",
        "Travelling Fair",
        "Treasure Chest",
        "Treasure Hunter",
        "Treasure Map",
        "Treasure Trove",
        "Treasurer",
        "Treasury",
        "Trickster",
        "Triumph",
        "Triumphal Arch",
        "Tunnel",
        "Twice Miserable",
        "Underling",
        "University",
        "Upgrade",
        "Urchin",
        "Vagrant",
        "Vampire",
        "Vassal",
        "Vault",
        "Villa",
        "Village",
        "Village Green",
        "Villain",
        "Vineyard",
        "Voyage",
        "Wall",
        "Walled Village",
        "Wandering Minstrel",
        "War",
        "War Chest",
        "Warehouse",
        "Warlord",
        "Warrior",
        "Watchtower",
        "Way of the Butterfly",
        "Way of the Camel",
        "Way of the Chameleon",
        "Way of the Frog",
        "Way of the Goat",
        "Way of the Horse",
        "Way of the Mole",
        "Way of the Monkey",
        "Way of the Mouse",
        "Way of the Mule",
        "Way of the Otter",
        "Way of the Owl",
        "Way of the Ox",
        "Way of the Pig",
        "Way of the Rat",
        "Way of the Seal",
        "Way of the Sheep",
        "Way of the Squirrel",
        "Way of the Turtle",
        "Way of the Worm",
        "Wayfarer",
        "Wealthy Village",
        "Weaver",
        "Wedding",
        "Werewolf",
        "Wharf",
        "Wheelwright",
        "Wild Hunt",
        "Will-o'-Wisp",
        "Windfall",
        "Wine Merchant",
        "Wish",
        "Wishing Well",
        "Witch",
        "Witch's Hut",
        "Wolf Den",
        "Woodworkers' Guild",
        "Worker's Village",
        "Workshop",
        "Young Witch",
        "Zombie Apprentice",
        "Zombie Mason",
        "Zombie Spy",
    ];

    const { S, D } = (() => {
        let p = new URLSearchParams(window.location.search);
        let S = parseInt(p.get("s"), 36);
        if (!p.has("s") || isNaN(S)) {
            S = Math.floor(Math.random() * 4294967296);
        }
        S = Math.abs(S) % 4294967296;
        let D = parseInt(p.get("d"));
        if (isNaN(D)) {
            D = Math.floor(Math.random() * 4294967296);
        }
        D = ((D % things.length) + things.length) % things.length;
        return { S, D };
    })();

    // https://stackoverflow.com/a/47593316
    /**
     * @param {Number} a
     * @param {Number} b
     * @param {Number} c
     * @param {Number} d
     */
    const sfc32 = (a, b, c, d) => () => {
        a |= 0;
        b |= 0;
        c |= 0;
        d |= 0;
        let t = (((a + b) | 0) + d) | 0;
        d = (d + 1) | 0;
        a = b ^ (b >>> 9);
        b = (c + (c << 3)) | 0;
        c = (c << 21) | (c >>> 11);
        c = (c + t) | 0;
        return (t >>> 0) / 4294967296;
    };
    const rand = sfc32(0x9e3779b9, 0x243f6a88, 0xb7e15162, S);

    /** @param {Array} a */
    const shuffle = (a) =>
        a
            .map((x) => ({ x, y: rand() }))
            .sort((a, b) => a.y - b.y)
            .map(({ x }) => x);

    /** @param {String} t */
    const tbt = (t) => {
        return t.replace(/\W/g, "").toUpperCase();
    };

    const guesses = new Set([...answers.map(tbt), ...allowed.map(tbt), ...things.map(tbt)]);

    /** @type {String} */
    const T = tbt(shuffle(things)[D]);
    const mxn = Math.max(...things.map((x) => tbt(x).length));

    const c = document.querySelector("#c");
    let w = document.createElement("div");
    w.classList.add("w");
    c.appendChild(w);

    window.addEventListener("keydown", (e) => {
        if (e.ctrlKey || e.altKey || e.metaKey || e.shiftKey) {
            return;
        }
        if (e.key === "Backspace") {
            if (w.hasChildNodes()) {
                w.removeChild(w.lastChild);
            }
            return;
        }
        if (e.key === "Enter") {
            let g = [...w.children].map((l) => l.textContent).join("");
            let ok = Array(g.length + 1).fill(0);
            ok[g.length] = 1;
            for (let i = g.length - 1; i >= 0; --i) {
                for (let j = 0; i + j <= g.length; ++j) {
                    if (guesses.has(g.substr(i, j))) {
                        console.log("has", i, j, g.substr(i, j));
                    }
                    ok[i] ||= guesses.has(g.substr(i, j)) && ok[i + j];
                }
            }
            console.log(ok);
            if (g != T && !ok[0]) {
                alert("Guess is not from dictionary");
                return;
            }
            let v = Array(g.length).fill("b");
            let i = 0;
            while (i < Math.min(g.length, T.length) && g[i] === T[i]) {
                v[i] = "g";
                v[0] = "g gs";
                ++i;
            }
            for (let x = 0; x < i; ++x) {
                if (x > 0) {
                    v[x] += " gl";
                }
                if (x + 1 < i) {
                    v[x] += " gr";
                }
            }
            if (g === T) {
                v[v.length - 1] += " ge";
            }
            let j = 0;
            while (j < Math.min(g.length, T.length) - i && g[g.length - 1 - j] === T[T.length - 1 - j]) {
                v[v.length - 1 - j] = "g";
                v[v.length - 1] = "g ge";
                ++j;
            }
            for (x = 0; x < j; ++x) {
                if (x > 0) {
                    v[v.length - 1 - x] += " gr";
                }
                if (x + 1 < j) {
                    v[v.length - 1 - x] += " gl";
                }
            }
            let dp = Array(T.length + 1)
                .fill(0)
                .map((_) =>
                    Array(g.length + 1)
                        .fill(0)
                        .map((_) => [0, 0, T.length, g.length])
                );
            for (x = T.length - j - 1; x >= i; --x) {
                for (let y = g.length - j - 1; y >= i; --y) {
                    let a = [...dp[x + 1][y]];
                    if (dp[x][y + 1][0] >= a[0]) {
                        a = [...dp[x][y + 1]];
                    }
                    a[1] = 0;
                    let m = 0;
                    while (x + m < T.length - j && y + m < g.length - j && T[x + m] === g[y + m]) {
                        ++m;
                    }
                    if (m && dp[x + m][y + m][0] + m * m >= a[0]) {
                        a = [dp[x + m][y + m][0] + m * m, m, x, y];
                    }
                    dp[x][y] = a;
                }
            }
            x = y = i;
            while (x != T.length && y != g.length) {
                let [_, m, nx, ny] = dp[x][y];
                if (m) {
                    for (let mi = 0; mi < m; ++mi) {
                        v[y + mi] = "g";
                        if (mi > 0) {
                            v[y + mi] += " gl";
                        }
                        if (mi + 1 < m) {
                            v[y + mi] += " gr";
                        }
                    }
                    nx += m;
                    ny += m;
                }
                x = nx;
                y = ny;
            }
            let f = Array(26).fill(0);
            for (let ch of T) {
                ++f[ch.charCodeAt(0) - "A".charCodeAt(0)];
            }
            let gc = 0;
            for (i = 0; i < g.length; ++i) {
                if (v[i] !== "b") {
                    ++gc;
                    --f[g[i].charCodeAt(0) - "A".charCodeAt(0)];
                }
            }
            let yc = 0;
            for (i = 0; i < g.length; ++i) {
                if (v[i] === "b" && f[g[i].charCodeAt(0) - "A".charCodeAt(0)]) {
                    v[i] = "y";
                    ++yc;
                    --f[g[i].charCodeAt(0) - "A".charCodeAt(0)];
                }
            }
            if (gc === 1 && yc <= 1) {
                for (i = 0; i < g.length; ++i) {
                    if (v[i].trim() === "g") {
                        v[i] = "y";
                    }
                }
            }
            for (i = 0; i < g.length; ++i) {
                w.children[i].className += " " + v[i];
            }
            w = document.createElement("div");
            w.classList.add("w");
            c.appendChild(w);
            return;
        }
        let k = e.key.toUpperCase();
        if (w.children.length >= mxn || k.length !== 1 || k < "A" || k > "Z") {
            return;
        }
        let l = document.createElement("div");
        l.classList.add("l");
        l.textContent = k;
        w.appendChild(l);
    });
</script>
